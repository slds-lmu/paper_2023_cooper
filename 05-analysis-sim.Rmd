---
title: "Simulation Results"
author: "Lukas"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(batchtools)
library(ggplot2)
library(dplyr)

# Load helper functions in R/
source(here::here("R/sim_cr.R"))
source(here::here("R/mt_res_tidy_plot.R"))
```

```{r}
res <-  ijoin(reduceResultsDataTable(), flatten(getJobPars()))
res
```

```{r}
res_long <- purrr::map2_df(res$problem, res$result, ~tidy_mt_res(.y, true_effects, problem = .x))

```

```{r}
(plot_bt_res(res_long, true_effects, "sim_a") + plot_bt_res(res_long, true_effects, "sim_b")) /
  (plot_bt_res(res_long, true_effects, "sim_c") + plot_bt_res(res_long, true_effects, "sim_d"))
```


Boxplot for `true-estimated`

```{r}
res_long |>
  filter(iter %in% c(0, 2), is_noise != "Noise", z_method == "original") |>
  select(-is_noise, -converged, -xcol) |>
  left_join(true_effects, by = c("problem", "beta", "x")) |>
  mutate(
    iter = if_else(iter == 0, "glmnet", "fwelnet_mt"),
    error = truth - value
  ) |>
  filter(problem == "sim_a") |> 
  ggplot(aes(x = x, y = error, fill = iter, color = iter)) +
  facet_grid(rows = vars(beta), cols = vars(z_scale), labeller = label_both) +
  geom_hline(yintercept = 0, lty = "longdash", size = 1) +
  #geom_jitter(alpha = 0.1, position = position_dodge2(width = .5, preserve = "single")) +
  geom_boxplot(alpha = 0.2) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill"), name = NULL) +
  labs(
    title = "A: Equal effect of x1 on both causes",
    subtitle = "Causes have same prevalence",
    x = NULL, y = "Error (true - estimated)"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.spacing = ggplot2::unit(1, "cm"),
    legend.position = "top",
    plot.title.position = "plot"
  )
```

