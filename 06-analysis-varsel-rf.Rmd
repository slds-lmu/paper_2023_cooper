---
title: "Simulation Results: Variable Selection"
author: "Lukas"
date: "`r Sys.time()`"
output: 
  html_document: 
    fig_width: 11
    fig_height: 9
    self_contained: no
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(batchtools)
library(ggplot2)
library(patchwork)
library(dplyr)
library(kableExtra)
library(data.table)

reg_name <- "fwel_sim_varsel_rf"
reg_dir <- here::here("registries", reg_name)
loadRegistry(reg_dir)

theme_set(
  theme_minimal(base_size = 16) +
  theme(
    legend.position = "bottom", 
    panel.spacing = unit(10, "mm"), 
    plot.title.position = "plot"
  )
)
```

```{r get-results, cache = TRUE}
res <-  ijoin(reduceResultsDataTable(), flatten(getJobPars()))
jobs_total <- nrow(getJobTable())
jobs_completed <- 100 * nrow(res)/jobs_total
jobs_errored <- 100 * nrow(findErrors())/jobs_total

res |>
  count(algorithm, problem, t, thresh) |>
  kable(caption = glue::glue("Finished jobs ({jobs_total} total, {jobs_completed}% completed, {jobs_errored}% errored)")) |>
  kable_styling()
```


```{r runtime-plot, fig.height=5, fig.width=7}
getJobTable() |>
  unwrap() |>
  #select(time.running, problem) |>
  mutate(time.running = as.double(time.running, units = "mins")) |>
  group_by(algorithm, problem, thresh) |>
  summarize(
    min = min(time.running),
    mean = mean(time.running),
    median = median(time.running),
    max = max(time.running),
    .groups = "drop"
  ) |>
  mutate(across(where(is.numeric), round, 1)) |>
  kable(caption = "Job runtime (mins)") |>
  kable_styling()
```

```{r prep-unnest-data}
# batchtools::unwrap() doesn't work, so quick tidyr-detour circling back to data.table
res_long <- tidyr::unnest(res, "result") |> 
  as.data.table()

# Make threshold scientific notation for consistency, it's a character then though.
res_long[, thresh := format(thresh, scientific = TRUE)]
```

For blocks without true effects, some measures should be NA rather than 0 to not confuse them:  
True positive & false negative are not meaningful in the absence of true effects -> NA -> derived measures are NA as well

```{r prep-cleanup-nonmeaningful-values}
res_long[total_pos == 0, tp := NA]
res_long[total_pos == 0, fn := NA]
```

Calculating derived measures, generating a lot of NAs for blocks without true effects.

```{r prep-calc-stats}
# TPR, FPR, PPV, FDR...
res_long[, tpr := tp/total_pos]
res_long[, fpr := fp/total_neg]
res_long[, ppv := tp/(tp + fp)]
res_long[, npv := tn/(tn + fn)]
res_long[, fdr := 1 - ppv]
res_long[, f1 := (2 * ppv * tpr) / (ppv + tpr)]
res_long[, acc := (tp+tn)/total]
```



## Covariates & true effects

```{r, include = FALSE}
tmp <- sim_surv_binder(n_train = 400, p = 5000)
truth <- tmp$covar_true_effect |> sapply(length)
total <- tmp$covar_blocks |> sapply(length)
```

Simulated data dimensions: n = 400, p = 5000

- **block 1**: 
    - correlation of 0.50 for j ≤ 0.05p
    - same effect (0.5) on both causes
    - true effects / variables per block: `r truth[["block1"]]` / `r total[["block1"]]`
- **block 2**: 
    - correlation of 0.35 for 0.05p < j ≤ 0.1p
    - Effects:
        - 0.5 on cause 1
        - 0.5 on cause 2
    - true effects / variables per block: `r truth[["block2"]]` / `r total[["block2"]]`
- **block 3**: 
    - correlation of 0.05 for 0.1p < j ≤ 0.2p
    - **block 3.1**, effect on cause 1 only: `r truth[["block31"]]` / `r total[["block31"]]`
    - **block 3.2**, effect on cause 2 only: `r truth[["block32"]]` / `r total[["block32"]]`
- **block 4**: 
    - correlation of 0.32 for 0.2p < j ≤ 0.3p
    - no effect on either cause
    - true effects / variables per block: `r truth[["block4"]]` / `r total[["block4"]]`
  
## Confusion Matrix stats
 
```{r confmat-measures-boxplot, fig.height=12}
res_long |>
  filter(thresh == "1e-07") |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  ggplot(aes(x = block, y = value, color = model, fill = model)) +
  facet_grid(rows = vars(measure), cols = vars(cause), scales = "free") +
  #coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Classification by model and covariate block",
    x = "Block", y = "Rate [%]"
  )
```

### As a table

#### Median and quartiles

```{r confmat-measures-table}
res_long |>
  filter(thresh == "1e-07") |>
  group_by(block, cause, model) |>
  summarise(across(tpr:acc, ~{
    # m <- round(mean(.x, na.rm = TRUE) * 100, 2)
    m <- round(median(.x, na.rm = TRUE) * 100, 2)
    qu <- round(quantile(.x * 100, probs = c(0.25, 0.75), na.rm = TRUE), 2)
    ifelse(
      is.finite(m),
      glue::glue("{m} <br\\> [{qu[[1]]}, {qu[[2]]}]"),
      "-"
    )
  }), .groups = "drop") |>
  kable(
    escape = FALSE,
    caption = "Median [p25, p75], measures multiplied by 100"
  ) |>
  kable_styling(bootstrap_options = c("hover")) |>
  collapse_rows(1:2)
```

#### Mean and quartiles

```{r confmat-measures-table-mean}
res_long |>
  filter(thresh == "1e-07") |>
  group_by(block, cause, model) |>
  summarise(across(tpr:acc, ~{
    m <- round(mean(.x, na.rm = TRUE) * 100, 2)
    qu <- round(quantile(.x * 100, probs = c(0.25, 0.75), na.rm = TRUE), 2)
    ifelse(
      is.finite(m),
      glue::glue("{m} <br\\> [{qu[[1]]}, {qu[[2]]}]"),
      "-"
    )
  }), .groups = "drop") |>
  kable(
    escape = FALSE,
    caption = "Mean [p25, p75], measures multiplied by 100"
  ) |>
  kable_styling(bootstrap_options = c("hover")) |>
  collapse_rows(1:2)
```

#### Raw confusion matrix stats

For completion's sake, the average confusion matrix stats (true positive, true negative, false positive...)

```{r confmat-measures-table-median}
res_long |>
  filter(thresh == "1e-07") |>
  group_by(block, cause, model) |>
  summarise(across(c(tp, tn, fp, fn), ~{
    m <- round(mean(.x, na.rm = TRUE), 2)
    qu <- round(quantile(.x, probs = c(0.25, 0.75), na.rm = TRUE), 2)
    ifelse(
      is.finite(m),
      glue::glue("{m} [{qu[[1]]}, {qu[[2]]}]"),
      "-"
    )  
  }), .groups = "drop") |>
  kable(
    caption = "Mean [p25, p75]"
  ) |>
  kable_styling(bootstrap_options = c("hover")) |>
  collapse_rows(1:2)
```



### Positive: Detection of true effects

TPR, PPV, F1?

Note on F1: Depends on ratio of positive/negative labels in true data, so comparison across different blocks with different numbers of true effects is not ideal.

```{r blockwise-pos-measures-boxplot, fig.height=12}
res_long |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("ACC","TPR", "PPV", "F1")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = factor(thresh), y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause, measure), cols = vars(block), scales = "free") +
  #coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Classification metrics by model and covariate block",
    x = "Threshold", y = "Rate [%]", color = NULL, fill = NULL
  )
```


### Negative: Removal of noise variables

Focusing on FDR.  
Especially relevant: Block4 without any true effects, and blocks 3.1 for cause 2 / block 3.2 for cause 1.

```{r blockwise-fpr-boxplot}
res_long |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause)
  ) |>
  ggplot(aes(x = factor(thresh), y = fpr, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  #coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .12)) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "False Positive Rate by model and covariate block",
    subtitle = "No true effects on cause 1 in block 3.2 (and vice versa)\nNo true effects in block 4 at all",
    x = "Threshold (lower = more theta optimization steps)", y = "False Positive Rate [%]", color = NULL, fill = NULL
  )

res_long |>
  filter(block != "block1", block != "block2") |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause)
  ) |>
  ggplot(aes(x = factor(thresh), y = fpr, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  #coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "False Positive Rate by model and covariate block",
    subtitle = "No true effects on cause 1 in block 3.2 (and vice versa)\nNo true effects in block 4 at all",
    x = "Threshold (lower = more theta optimization steps)", y = "False Positive Rate [%]", color = NULL, fill = NULL
  )
```


### ROC-Like Bidimensional Scatter

Hard to make out anything useful except that fwelnet seems to work fine and block3.2/cause 2 is harder than 3.1/cause 1 :/

```{r roc-}
res_long |>
  filter(thresh == "1e-03")|>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause)
  ) |>
  filter(!is.na(tpr)) |>
  ggplot(aes(x = fpr, y = tpr, color = model, fill = model)) +
  facet_grid(rows = vars(block), cols = vars(cause), scales = "free") +
  geom_point(position = position_jitter(width = 0.01, height = 0.01), alpha = .5, size = 3) +
  geom_hline(yintercept = 1:4 * 0.25, lty = "dashed", color = "darkgray") +
  geom_abline(slope = 1, intercept = 0, lty = "dashed", color = "black") +
  scale_x_continuous(labels = scales::percent_format(), limits = c(0, 0.1)) +
  scale_y_continuous(labels = scales::percent_format(), breaks = 0:4 * 0.25) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Classification metrics by model and covariate block",
    subtitle = " Jitter +/- 0.01 applied on both axes for visibility",
    x = "False Positive Rate", y = "True Positive Rate", color = NULL, fill = NULL
  )
```


