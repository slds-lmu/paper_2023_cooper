---
title: "Simulation Results: Variable Selection"
author: "Lukas"
date: "`r Sys.time()`"
output: 
  html_document: 
    fig_width: 11
    fig_height: 9
    self_contained: no
    code_folding: hide
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(batchtools)
library(ggplot2)
library(patchwork)
library(dplyr)
library(kableExtra)
library(data.table)
source(here::here("2-variable-selection-sim/2-simulation.R"))

result_file <- here::here("2-variable-selection-sim/results.rds")

reg_name <- "varsel"
reg_dir <- here::here("registries", reg_name)
loadRegistry(reg_dir)

theme_set(
  theme_minimal(base_size = 16) +
  theme(
    legend.position = "bottom", 
    panel.spacing = unit(10, "mm"), 
    plot.title.position = "plot"
  )
)
```

```{r get-results, eval=!file.exists(result_file)}
res <-  ijoin(reduceResultsDataTable(), flatten(getJobPars()))
jobs_total <- nrow(getJobTable())
jobs_completed <- 100 * nrow(res)/jobs_total
jobs_errored <- 100 * nrow(findErrors())/jobs_total

saveRDS(res, result_file)
```

```{r, eval=file.exists(result_file)}
res <- readRDS(result_file)
```


```{r runtime-plot, fig.height=5, fig.width=7}
getJobTable() |>
  unwrap() |>
  #select(time.running, problem) |>
  mutate(time.running = as.double(time.running, units = "mins")) |>
  group_by(algorithm, problem) |>
  summarize(
    min = min(time.running, na.rm = TRUE),
    mean = mean(time.running, na.rm = TRUE),
    median = median(time.running, na.rm = TRUE),
    max = max(time.running, na.rm = TRUE),
    n = n(),
    n_complete = sum(!is.na(time.running)),
    .groups = "drop"
  ) |>
  mutate(across(where(is.numeric), \(x) round(x, 1))) |>
  kable(caption = "Job runtime (mins)") |>
  kable_styling()
```

```{r prep-unnest-data}
# batchtools::unwrap() doesn't work, so quick tidyr-detour circling back to data.table
res_long <- tidyr::unnest(res, "result") |> 
  as.data.table()

# Make threshold scientific notation for consistency, it's a character then though.
res_long[, thresh := format(thresh, scientific = TRUE)]
res_long[, block := gsub("3", "3.", block)]
res_long[, block := factor(block, levels = sort(unique(block)))]

res_long[, lambda_setting := fcase(
  lambda1 == lambda2, "equal",
  lambda1 < lambda2,  "c1 less"
)]

res_long |>
  count(lambda1, lambda2, lambda_setting)

# Params for methods
params_fwelnet <- c("t", "thresh", "mt_max_iter", "alpha")
params_rfsrc <- c("importance", "cutoff_method", "mtry", "nodesize", "splitrule")
params_coxboost <- c("cmprsk", "stepno", "penalty")

params_sim <- c("n_train", "p", "ce", "lambda1", "lambda2", "lambda_c")

```

For blocks without true effects, some measures should be NA rather than 0 to not confuse them:  
True positive & false negative are not meaningful in the absence of true effects -> NA -> derived measures are NA as well

```{r prep-cleanup-nonmeaningful-values}
res_long[total_pos == 0, tp := NA]
res_long[total_pos == 0, fn := NA]
```

Calculating derived measures, generating a lot of NAs for blocks without true effects.

```{r prep-calc-stats}
# TPR, FPR, PPV, FDR...
res_long[, tpr := tp/total_pos]
res_long[, fpr := fp/total_neg]
res_long[, ppv := tp/(tp + fp)]
res_long[, npv := tn/(tn + fn)]
res_long[, fdr := 1 - ppv]
res_long[, f1 := (2 * ppv * tpr) / (ppv + tpr)]
res_long[, acc := (tp+tn)/total]
```

### WIP Attempt at subsetting/subplotting

```{r prep-subset}
plot_varselect_boxplot <- function(
    res_long, ..., measure, blocks = c("block1", "block2", "block3.1", "block3.2", "block4", "noise"),
    lambda_setting = "equal",
    append_hpc = FALSE
  ) {
  #browser()
  
  tmp <- res_long |> 
    dplyr::filter(.data$lambda_setting == .env$lambda_setting) |>
    filter(...)
  
  if (lambda_setting == "equal") {
    label_sub <- "Setting with roughly equal proportions of causes 1 & 2" 
  } else if (lambda_setting == "c1 less") {
    label_sub <- "Setting with cause 1 appearing less frequently than cause 2"
  }
  
  tmp |>
    filter(.data$block %in% .env$blocks) |>
    mutate(
      model = dplyr::case_when(
        model == "fwelnet" ~ "CooPeR",
        model == "coxboost" ~ "CoxBoost",
        model == "glmnet" ~ "Pen. Cox",
        model == "rfsrc" ~ "RSF"
      ),
      model = factor(model, levels = rev(c("CooPeR", "Pen. Cox", "RSF", "CoxBoost")))
    ) |>
    tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
    filter(.data$measure == .env$measure) |>
    # Pre=plot cosmetics
    mutate(
      cause = paste0("Cause ", cause),
      block = stringr::str_replace_all(block, "block", "Block ")
    ) |>
    ggplot(aes(y = reorder(model, value), x = value, color = model, fill = model)) +
    facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
    #coord_flip() +
    geom_boxplot(alpha = 0.5, show.legend = FALSE) +
    scale_x_continuous(labels = scales::label_percent()) +
    scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
    labs(
      title = glue::glue("Variable Selection Performance: {measure}"),
      subtitle = label_sub,
      y = NULL, x = glue::glue("{measure} [%]")
    )
}

plot_varselect_boxplot(
  res_long, measure = "PPV", 
  #model %in% c("fwelnet", "glmnet"),
  lambda_setting = "equal",
  blocks = c("block1", "block2", "block3.1", "block3.2")
)

plot_varselect_boxplot(
  res_long, measure = "PPV", 
  #model %in% c("fwelnet", "glmnet"),
  lambda_setting = "c1 less",
  blocks = c("block1", "block2", "block3.1", "block3.2")
)

plot_varselect_boxplot(
  res_long, measure = "FPR", 
  sim_setting = "equal",
  blocks = c("block1", "block2", "block3.1", "block3.2", "noise")
)
```



## Covariates & true effects

```{r, include = FALSE}
tmp <- sim_surv_binder(n_train = 100, p = 5000)
truth <- tmp$covar_true_effect |> sapply(length)
total <- tmp$covar_blocks |> sapply(length)
```

Simulated data dimensions: n = 400, p = 5000

- **block 1**: 
    - correlation of 0.50 for j ≤ 0.05p
    - same effect (0.5) on both causes
    - true effects / variables per block: `r truth[["block1"]]` / `r total[["block1"]]`
- **block 2**: 
    - correlation of 0.35 for 0.05p < j ≤ 0.1p
    - Effects:
        - 0.5 on cause 1
        - -0.5 on cause 2
    - true effects / variables per block: `r truth[["block2"]]` / `r total[["block2"]]`
- **block 3**: 
    - correlation of 0.05 for 0.1p < j ≤ 0.2p
    - **block 3.1**, effect on cause 1 only: `r truth[["block31"]]` / `r total[["block31"]]`
    - **block 3.2**, effect on cause 2 only: `r truth[["block32"]]` / `r total[["block32"]]`
- **block 4**: 
    - correlation of 0.32 for 0.2p < j ≤ 0.3p
    - no effect on either cause
    - true effects / variables per block: `r truth[["block4"]]` / `r total[["block4"]]`
  
## Confusion Matrix stats
 
```{r confmat-measures-boxplot, fig.height=12, eval=FALSE}
res_long |>
  mutate(
    cause = paste0("Cause ", cause),
    model = ifelse(model == "rfsrc", glue::glue("{model} (mtry={mtry})"), model),
    model = ifelse(model == "coxboost", glue::glue("{model} ({cmprsk})"), model)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  ggplot(aes(x = block, y = value, color = model, fill = model)) +
  facet_grid(rows = vars(measure), cols = vars(cause), scales = "free") +
  #coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Classification by model and covariate block",
    x = "Block", y = "Rate [%]"
  )
```

### As a table

#### Median and quartiles

```{r confmat-measures-table}
res_long |>
  group_by(block, cause, model) |>
  summarise(across(tpr:acc, ~{
    # m <- round(mean(.x, na.rm = TRUE) * 100, 2)
    m <- round(median(.x, na.rm = TRUE) * 100, 2)
    qu <- round(quantile(.x * 100, probs = c(0.25, 0.75), na.rm = TRUE), 2)
    ifelse(
      is.finite(m),
      glue::glue("{m} <br\\> [{qu[[1]]}, {qu[[2]]}]"),
      "-"
    )
  }), 
  .groups = "drop"
  ) |>
  kable(
    escape = FALSE,
    caption = "Median [p25, p75], measures multiplied by 100"
  ) |>
  kable_styling(bootstrap_options = c("hover")) |>
  collapse_rows(1:2)
```

#### Mean and quartiles

```{r confmat-measures-table-mean}
res_long |>
  group_by(block, cause, model) |>
  summarise(across(tpr:acc, ~{
    m <- round(mean(.x, na.rm = TRUE) * 100, 2)
    qu <- round(quantile(.x * 100, probs = c(0.25, 0.75), na.rm = TRUE), 2)
    ifelse(
      is.finite(m),
      glue::glue("{m} <br\\> [{qu[[1]]}, {qu[[2]]}]"),
      "-"
    )
  }), .groups = "drop") |>
  kable(
    escape = FALSE,
    caption = "Mean [p25, p75], measures multiplied by 100"
  ) |>
  kable_styling(bootstrap_options = c("hover")) |>
  collapse_rows(1:2)
```

#### Raw confusion matrix stats

For completion's sake, the average confusion matrix stats (true positive, true negative, false positive...)

```{r confmat-measures-table-median}
res_long |>
  group_by(block, cause, model) |>
  summarise(across(c(tp, tn, fp, fn), ~{
    m <- round(mean(.x, na.rm = TRUE), 2)
    qu <- round(quantile(.x, probs = c(0.25, 0.75), na.rm = TRUE), 2)
    ifelse(
      is.finite(m),
      glue::glue("{m} [{qu[[1]]}, {qu[[2]]}]"),
      "-"
    )  
  }), .groups = "drop") |>
  kable(
    caption = "Mean [p25, p75]"
  ) |>
  kable_styling(bootstrap_options = c("hover")) |>
  collapse_rows(1:2)
```

### Positive: Detection of true effects

Subset to only PPV with more model differentiation

```{r blockwise-ppv-boxplot}
res_long |>
  filter(lambda2 == lambda1) |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    model = ifelse(model == "rfsrc", glue::glue("{model} (mtry={mtry})"), model),
    model = ifelse(model == "coxboost", glue::glue("{model} ({cmprsk})"), model)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("PPV")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = reorder(model, value), y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Classification metrics by model and covariate block",
    subtitle = "Simulation setting with approx. equal proportions of cause 1 and 2",
    x = "Model", y = "PPV [%]", color = NULL, fill = NULL
  )

res_long |>
  filter(lambda2 < lambda1) |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    model = ifelse(model == "rfsrc", glue::glue("{model} (mtry={mtry})"), model),
    model = ifelse(model == "coxboost", glue::glue("{model} ({cmprsk})"), model)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("PPV")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = reorder(model, value), y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Classification metrics by model and covariate block",
    subtitle = "Simulation setting with cause 2 having smaller event counts",
    x = "Model", y = "PPV [%]", color = NULL, fill = NULL
  )
```

#### CoxBoost only

```{r blockwise-ppv-coxboost}
res_long |>
  filter(lambda2 == lambda1, model == "coxboost") |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    model = ifelse(model == "coxboost", glue::glue("{model} ({cmprsk}, penalty={penalty}, stepno={stepno})"), model)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("PPV")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = reorder(model, value), y = value)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  #scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "CoxBoost: Classification metrics by model and covariate block",
    subtitle = "Simulation setting with approx. equal proportions of cause 1 and 2",
    x = "Model", y = "PPV [%]", color = NULL, fill = NULL
  )
```

#### RFSRC only

```{r blockwise-ppv-rfsrc}
res_long |>
  filter(lambda2 == lambda1, model == "rfsrc") |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    model = ifelse(model == "rfsrc", glue::glue("{model} (mtry={mtry}, {nodesize})"), model)
  ) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("PPV")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = reorder(model, value), y = value)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  #scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "RFSRC: Classification metrics by model and covariate block",
    subtitle = "Simulation setting with approx. equal proportions of cause 1 and 2",
    x = "Model", y = "PPV [%]", color = NULL, fill = NULL
  )
```

### Negative: Removal of noise variables

Focusing on FPR.  
Especially relevant: Block4 without any true effects, and blocks 3.1 for cause 2 / block 3.2 for cause 1.

```{r blockwise-fpr-boxplot}
res_long |>
  filter(lambda1 == lambda2) |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    model = ifelse(model == "rfsrc", glue::glue("{model} (mtry={mtry})"), model),
    model = ifelse(model == "coxboost", glue::glue("{model} ({cmprsk})"), model)
  ) |>
  ggplot(aes(x = model, y = fpr, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, .12)) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "False Positive Rate by model and covariate block",
    subtitle = "No true effects on cause 1 in block 3.2 (and vice versa)\nNo true effects in block 4 at all",
    x = "Model", y = "False Positive Rate [%]", color = NULL, fill = NULL
  )

res_long |>
  filter(block != "block1", block != "block2", lambda1 == lambda2) |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    model = ifelse(model == "rfsrc", glue::glue("{model} (mtry={mtry})"), model),
    model = ifelse(model == "coxboost", glue::glue("{model} ({cmprsk})"), model)
  ) |>
  ggplot(aes(x = reorder(model, -fpr), y = fpr, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "False Positive Rate by model and covariate block",
    subtitle = "No true effects on cause 1 in block 3.2 (and vice versa)\nNo true effects in block 4 at all",
    x = "Model", y = "False Positive Rate [%]", color = NULL, fill = NULL
  )
```

## Selected Plots for Paper

Some tweaks for presentability purposes

```{r}
res_long_selected <- res_long |>
  filter(model != "coxboost" | (penalty == 3000 & stepno == 100 & cmprsk == "csh")) |>
  filter(model != "rfsrc" | (mtry == 500)) |>
  mutate(
    block = stringr::str_replace_all(block, "31", "3.1"),
    block = stringr::str_replace_all(block, "32", "3.2"),
    cause = paste0("Cause ", cause),
    block = case_when(
      block == "block1" ~ "B1 (Mutual)",
      block == "block2" ~ "B2 (Reversed)",
      block == "block3.1" ~ "B3 (Disjoint 1)",
      block == "block3.2" ~ "B3 (Disjoint 2)",
      block == "block4" ~ "B4 (Cor. Noise)",
      TRUE ~ "Noise"
    ),
    model = case_when(
      model == "fwelnet" ~ "CooPeR",
      model == "coxboost" ~ "CoxBoost",
      model == "glmnet" ~ "Coxnet",
      model == "rfsrc" ~ "RSF"
    ),
    model = factor(model, levels = rev(c("CooPeR", "Coxnet", "RSF", "CoxBoost")))
  )
```



```{r, include=FALSE, eval=FALSE}
# Finding generally best coxboost first
cb_jobs <- res_long |>
  filter(lambda2 == lambda1, model == "coxboost") |>
  select(cause, block, cmprsk, stepno, penalty, tpr:acc)

cb_jobs |>
  rowwise() |>
  mutate(hpc = paste0(c(as.character(cmprsk), penalty, stepno), collapse = "-")) |>
  group_by(hpc) |>
  summarize(median_ppv = median(ppv, na.rm = TRUE)) |>
  arrange(desc(median_ppv))

cb_jobs |>
  rowwise() |>
  mutate(hpc = paste0(c(as.character(cmprsk), penalty, stepno), collapse = "-")) |>
  group_by(hpc) |>
  summarize(median_fpr = median(fpr, na.rm = TRUE)) |>
  arrange(median_fpr)
```



```{r selected-ppv-equallambda}
p_ppv1 <- res_long_selected |>
  filter(lambda2 == lambda1) |>
  #filter(grepl("^B[12]", block)) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("PPV")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = model, y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill"), guide = "none") +
  labs(
    #title = "Detection of true effects: PPV",
   # subtitle = "Simulation setting with approx. equal proportions of cause 1 and 2",
    x = NULL, y = "PPV [%]", color = NULL, fill = NULL
  )

ggsave(plot = p_ppv1, filename = "selected-ppv-equallambda.pdf", path = here::here("selected-plots"), width = 12, height = 4)
ggsave(plot = p_ppv1, filename = "selected-ppv-equallambda.png", path = here::here("selected-plots"), width = 12, height = 4, bg = "white")
```

```{r selected-ppv-difflambda}
p_ppv2 <- res_long_selected |>
  filter(lambda2 == 0.01 & lambda1 == 0.1) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("PPV")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = model, y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill"), guide = "none") +
  labs(
    title = "Detection of true effects: PPV",
    subtitle = "Simulation setting with cause 2 less prevalent",
    x = NULL, y = "PPV [%]", color = NULL, fill = NULL
  )

ggsave(plot = p_ppv2, filename = "selected-ppv-difflambda.pdf", path = "selected-plots", width = 16, height = 7)
ggsave(plot = p_ppv2, filename = "selected-ppv-difflambda.png", path = "selected-plots", width = 16, height = 7)
```

```{r selected-fpr-equallambda}
p_fpr1 <- res_long_selected |>
  filter(lambda2 == lambda1) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("FPR")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = model, y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format(), breaks = scales::pretty_breaks(n = 3)) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill"), guide = "none") +
  labs(
    # title = "Susceptibility to noise: FPR",
    # subtitle = "Simulation setting with approx. equal proportions of cause 1 and 2",
    x = NULL, y = "FPR [%]", color = NULL, fill = NULL
  )

ggsave(plot = p_fpr1, filename = "selected-fpr-equallambda.pdf", path = "selected-plots", width = 14, height = 4)
ggsave(plot = p_fpr1, filename = "selected-fpr-equallambda.png", path = "selected-plots", width = 14, height = 4, bg = "white")
```

```{r selected-fpr-difflambda}
p_fpr2 <- res_long_selected |>
  filter(lambda2 == 0.01 & lambda1 == 0.1) |>
  tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
  filter(measure %in% c("FPR")) |>
  filter(!is.na(value)) |>
  ggplot(aes(x = model, y = value, color = model, fill = model)) +
  facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
  coord_flip() +
  geom_boxplot(alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill"), guide = "none") +
  labs(
    title = "Susceptibility to noise: FPR",
    subtitle = "Simulation setting with cause 2 less prevalent",
    x = NULL, y = "FPR [%]", color = NULL, fill = NULL
  )

ggsave(plot = p_fpr2, filename = "selected-fpr-difflambda.pdf", path = "selected-plots", width = 16, height = 7)
ggsave(plot = p_fpr2, filename = "selected-fpr-difflambda.png", path = "selected-plots", width = 16, height = 7)
```


### CEN versions

```{r}
plot_boxplot_subset <- function(data, measure, ...) {
  xdat <- data |>
    filter(...) |>
    tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
    filter(measure %in% .env$measure) |>
    filter(!is.na(value))
  
  # if (measure == "PPV") {
    xdat <- xdat |>
      mutate(block = ifelse(grepl("^B3", block),
                            "B3 (Disjoint)", block))
  # }
  
  if (measure == "FPR") {
    # xdat <- xdat |>
    #   filter(!(block %in% c("B4 (Cor. Noise)", "Noise")))
    #   filter(!(block %in% c("Noise")))
  }
  
  xdat |>
    dplyr::mutate(block = factor(block, levels = sort(unique(block)))) |>
    ggplot(aes(x = model, y = value, color = model, fill = model)) +
    facet_grid(rows = vars(cause), cols = vars(block), scales = "free") +
    coord_flip() +
    geom_boxplot(alpha = 0.5) +
    scale_y_continuous(labels = \(x) x * 100) +
    scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill"), guide = "none") +
    labs(
      #title = "Detection of true effects: PPV",
      #subtitle = "Simulation setting with approx. equal proportions of cause 1 and 2",
      x = NULL, y = glue::glue("{measure} [%]"), color = NULL, fill = NULL
    )
}

# THis is somehow the most frankensteinian of all loops.
for (measure in c("PPV", "FPR")) {
  #for (blocks in c("^B[12]", "^B[34]")) {
    
    width <- ifelse(measure == "FPR", 10, 8.5)
    height <- ifelse(measure == "FPR", 3.5, 3)
 
    p <- plot_boxplot_subset(res_long_selected, measure = measure, lambda1 == lambda2)
  
    filename <- glue::glue("selected-plots/cen-selected-{tolower(measure)}-equallambda.pdf")
    ggsave(filename = filename, plot = p, width = width, height = height)
    
    p2 <- dplyr::filter(res_long_selected, cause == "Cause 1") |>
      plot_boxplot_subset(measure = measure, lambda1 == lambda2)
    filename <- glue::glue("selected-plots/cen-selected-{tolower(measure)}-equallambda-cause1.pdf")
    ggsave(filename = filename, plot = p2, width = width, height = height)
  #}
}

```

## Tables

```{r}
measure_table <- function(res_long_selected, measure = "PPV", aggr_point = median, aggr_var = IQR, minmax = max) {
  res_long_selected |>
    filter(lambda2 == lambda1) |>
    #filter(grepl("^B[12]", block)) |>
    tidyr::pivot_longer(cols = tpr:acc, names_to = "measure", values_to = "value", names_transform = toupper) |>
    filter(.data$measure %in% .env$measure) |>
    filter(!is.na(value)) |>
    select(model, cause, block, value) |>
    group_by(model, cause, block) |>
    summarize(
      aggr = 100 * aggr_point(value),
      aggrv = 100 * aggr_var(value),
      .groups = "drop"
    ) |>
    group_by(cause, block) |>
    mutate(
      stat_formatted = glue::glue("{round(aggr, 2)} ({round(aggrv, 2)})"),
      stat_formatted = cell_spec(stat_formatted, bold = aggr == minmax(aggr), format = kbl_format)
    ) |>
    ungroup() |>
    select(-aggr, -aggrv) |>
    tidyr::pivot_wider(names_from = model, values_from = stat_formatted) |>
    select(Cause = cause, Block = block, CooPeR, Coxnet, CoxBoost, RSF)
}

ppv_tbl_median <- measure_table(res_long_selected, measure = "PPV", aggr_point = median, aggr_var = IQR, minmax = max)
ppv_tbl_mean <- measure_table(res_long_selected, measure = "PPV", aggr_point = mean, aggr_var = sd, minmax = max)

fpr_tbl_median <- measure_table(res_long_selected, measure = "FPR", aggr_point = median, aggr_var = IQR, minmax = min)
fpr_tbl_mean <- measure_table(res_long_selected, measure = "FPR", aggr_point = mean, aggr_var = sd, minmax = min)

```


```{r ppv-table}
kbl_format <- "latex"
options(knitr.table.format = kbl_format)

ppv_kbl_median <- ppv_tbl_median |>
  select(-Cause) |>
  kbl(
    caption = "Median (IQR) of PPV scores (\\%) across different covariate blocks for causes 1 and 2.\\label{tab:ppv-median}",
    escape = FALSE, booktabs = TRUE, format = kbl_format
  ) |>
  kable_styling(protect_latex = TRUE) |>
  footnote(general = "Method with highest scores within each cause/block", general_title = "Bold:") |>
  pack_rows(index = table(ppv_tbl_median$Cause))

ppv_kbl_mean <- ppv_tbl_mean |>
  select(-Cause) |>
  kbl(
    caption = "Mean (SD) of PPV scores (\\%) across different covariate blocks for causes 1 and 2.\\label{tab:ppv-mean}",
    escape = FALSE, booktabs = TRUE, format = kbl_format
  ) |>
  kable_styling(protect_latex = TRUE) |>
  footnote(general = "Method with highest scores within each cause/block", general_title = "Bold:") |>
  pack_rows(index = table(ppv_tbl_mean$Cause))

if (kbl_format == "latex") {
  writeLines(ppv_kbl_median, con = here::here("tables", "ppv-median.tex"))
}

if (kbl_format == "latex") {
  writeLines(ppv_kbl_mean, con = here::here("tables", "ppv-mean.tex"))
}

```

```{r fpr-table}
kbl_format <- "latex"
options(knitr.table.format = kbl_format)

fpr_kbl_median <- fpr_tbl_median |>
  select(-Cause) |>
  kbl(
    caption = "Median (IQR) of FPR scores (\\%) across different covariate blocks for causes 1 and 2.\\label{tab:fpr-median}",
    escape = FALSE, booktabs = TRUE, format = kbl_format
  ) |>
  kable_styling(protect_latex = TRUE) |>
  footnote(general = "Method with lowest scores within each cause/block", general_title = "Bold:") |>
  pack_rows(index = table(fpr_tbl_median$Cause))

fpr_kbl_mean <- fpr_tbl_mean |>
  select(-Cause) |>
  kbl(
    caption = "Mean (SD) of FPR scores (\\%) across different covariate blocks for causes 1 and 2.\\label{tab:fpr-mean}",
    escape = FALSE, booktabs = TRUE, format = kbl_format
  ) |>
  kable_styling(protect_latex = TRUE) |>
  footnote(general = "Method with lowest scores within each cause/block", general_title = "Bold:") |>
  pack_rows(index = table(fpr_tbl_mean$Cause))

if (kbl_format == "latex") {
  writeLines(fpr_kbl_median, con = here::here("tables", "fpr-median.tex"))
}

if (kbl_format == "latex") {
  writeLines(fpr_kbl_mean, con = here::here("tables", "fpr-mean.tex"))
}
```
